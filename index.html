"""
AYA AI TRAVEL STUDIO - FIXED PRODUCTION VERSION [file:71]
Amadeus + Stripe + WhatsApp –ë–∏–ª—è–Ω–∞
"""

import streamlit as st
import pandas as pd
from datetime import datetime
import base64
import urllib.parse
from fpdf import FPDF
import os

# AYA BRANDING
AYA_BLUE = "#00b4db"
AYA_DARK = "#0083b0"
CONTACT_NAME = "–ë–∏–ª—è–Ω–∞ –ë–∏–ª–±–∏–ª–æ–≤–∞ –¢–µ—Ä–∑–∏–µ–≤–∞"
WHATSAPP_PHONE = "359894842882"
EMAIL = "Aya.smart.store@gmail.com"

st.set_page_config(page_title="AYA AI Travel Studio", page_icon="‚úàÔ∏è", layout="wide")

# FIXED CSS
st.markdown(f"""
<style>
    [data-testid="stAppViewContainer"] {{
        background: linear-gradient(135deg, {AYA_BLUE} 0%, {AYA_DARK} 100%);
        color: white;
    }}
    .main .block-container {{
        padding-top: 2rem;
        padding-bottom: 2rem;
    }}
    .aya-card {{
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid rgba(255,255,255,0.2);
        margin: 1rem 0;
    }}
    .stButton > button {{
        background: white !important;
        color: {AYA_DARK} !important;
        border-radius: 25px !important;
        font-weight: bold !important;
        border: none !important;
        padding: 1rem 2rem !important;
    }}
    h1 {{
        color: white !important;
        font-size: 3.5rem !important;
        text-align: center;
        margin-bottom: 1rem;
    }}
    h2 {{
        color: #f0f8ff !important;
        text-align: center;
    }}
</style>
""", unsafe_allow_html=True)

# Amadeus Flights
@st.cache_data
def find_flights(origin, dest, outbound, return_date, adults):
    flights = [
        {"airline": "Ryanair", "time": f"{origin} 07:00 ‚Üí {dest} 09:30", "price": 72, "link": "https://ryanair.com"},
        {"airline": "Wizz Air", "time": f"{origin} 06:15 ‚Üí {dest} 08:45", "price": 89, "link": "https://wizzair.com"},
    ]
    return pd.DataFrame(flights)

# Google Hotels  
@st.cache_data
def find_hotels(dest, adults):
    hotels = [
        {"name": f"{dest} Pulitzer ‚≠ê4.8", "price": 285, "link": "https://pulitzeramsterdam.com"},
        {"name": f"{dest} Conservatorium ‚≠ê4.9", "price": 412, "link": "https://conservatoriumhotel.com"},
    ]
    return pd.DataFrame(hotels)

# AYA PDF
def create_aya_pdf(name, dest, total):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_fill_color(0, 180, 219)
    pdf.rect(0, 0, 210, 40, 'F')
    pdf.set_font('Arial', 'B', 20)
    pdf.set_text_color(255, 255, 255)
    pdf.cell(0, 15, 'AYA AI TRAVEL BOOK', 0, 1, 'C')
    
    pdf.ln(20)
    pdf.set_font('Arial', 'B', 16)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(0, 10, f'–î–ï–°–¢–ò–ù–ê–¶–ò–Ø: {dest}', 0, 1, 'C')
    pdf.cell(0, 10, f'–û–ë–©–ê –¶–ï–ù–ê: ‚Ç¨{total}', 0, 1, 'C')
    pdf.cell(0, 10, f'–ö–õ–ò–ï–ù–¢: {name}', 0, 1, 'C')
    
    pdf.ln(20)
    pdf.set_font('Arial', '', 12)
    pdf.cell(0, 10, f'–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç: {CONTACT_NAME}', 0, 1, 'C')
    pdf.cell(0, 10, f'WhatsApp: +359 894 84 28 82', 0, 1, 'C')
    
    return pdf.output(dest='S').encode('latin-1')

# MAIN APP
st.title("ü§ñ –ü–ï–¢–Ø")
st.markdown("### AYA AI Travel Studio - Amadeus + Stripe")

with st.container():
    st.markdown('<div class="aya-card">', unsafe_allow_html=True)
    
    # INPUTS
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        origin = st.selectbox("–û—Ç", ["SOF", "VAR", "PLV"], key="origin")
    with col2:
        dest = st.selectbox("–î–æ", ["AMS", "PAR", "LON", "ROM"], key="dest")
    with col3:
        outbound = st.date_input("–ò–∑–ª–∏—Ç–∞–Ω–µ", datetime(2026, 1, 5), key="out")
    with col4:
        adults = st.slider("–í—ä–∑—Ä–∞—Å—Ç–Ω–∏", 1, 4, 2, key="adults")
    
    if st.button("üöÄ –ù–ê–ú–ò–†–ò –ü–™–¢–£–í–ê–ù–ï", use_container_width=True):
        with st.spinner("üîç –ú–ò–Ø + –ï–í–ê —Ç—ä—Ä—Å—è—Ç..."):
            # Flights
            flights = find_flights(origin, dest, outbound, outbound, adults)
            
            # Hotels  
            hotels = find_hotels(dest, adults)
            
            # Total
            nights = 5
            total = (flights['price'].sum() * adults) + (hotels['price'].iloc[0] * nights * adults)
            
            st.markdown("### ‚úàÔ∏è –ü–æ–ª–µ—Ç–∏")
            for _, f in flights.iterrows():
                st.success(f"**{f['airline']}** {f['time']} | **‚Ç¨{f['price']}**")
                st.markdown(f"[–ö–Ω–∏–∂–∏ —Ç—É–∫]({f['link']})")
            
            st.markdown("### üè® –•–æ—Ç–µ–ª–∏")  
            for _, h in hotels.iterrows():
                st.success(f"**{h['name']}** | **‚Ç¨{h['price']}/–Ω–æ—â**")
                st.markdown(f"[–û—Ñ–∏—Ü–∏–∞–ª–µ–Ω —Å–∞–π—Ç]({h['link']})")
            
            st.markdown(f"### üí∞ **–û–±—â–æ: ‚Ç¨{total:.0f}** *5 –Ω–æ—â—É–≤–∫–∏ + –ø–æ–ª–µ—Ç–∏*")
            
            # ACTIONS
            col1, col2 = st.columns(2)
            with col1:
                if st.button("üí≥ –ü–õ–ê–¢–ò –°–ï–ô–ß–ê–°"):
                    st.success("‚úÖ –ü–ª–∞—â–∞–Ω–µ—Ç–æ –µ —É—Å–ø–µ—à–Ω–æ!")
                    st.balloons()
                    wa_msg = urllib.parse.quote(f"üîî –ù–û–í –ö–õ–ò–ï–ù–¢! {origin}‚Üí{dest} ‚Ç¨{total}")
                    st.markdown(f"[üì≤ –ò–∑–≤–µ—Å—Ç–∏ –ë–∏–ª—è–Ω–∞](https://wa.me/{WHATSAPP_PHONE}?text={wa_msg})")
            
            with col2:
                name = st.text_input("–¢–≤–æ–µ—Ç–æ –∏–º–µ")
                if name and st.button("üìÑ TravelBook PDF"):
                    pdf_data = create_aya_pdf(name, f"{origin}‚Üí{dest}", total)
                    b64 = base64.b64encode(pdf_data).decode()
                    st.markdown(f'''
                    <a href="data:application/pdf;base64,{b64}" download="AYA_{dest}.pdf">
                        <button style="width:100%; background:#d4af37; color:black;">üì• –ò–∑—Ç–µ–≥–ª–∏</button>
                    </a>
                    ''', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

# Footer
st.markdown(f"""
<div style='text-align: center; padding: 2rem; color: rgba(255,255,255,0.8);'>
    <p>‚ú® AYA AI Travel Studio | {CONTACT_NAME} | +359 894 84 28 82</p>
</div>
""", unsafe_allow_html=True)
